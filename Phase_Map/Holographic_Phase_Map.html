<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neuro Diagnostic</title>
    <style>
        body { 
            margin: 0; 
            background-color: #000; 
            color: #0f0; 
            font-family: 'Courier New', monospace; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            height: 100vh;
        }
        
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            background: rgba(0, 20, 0, 0.8);
            z-index: 10;
            text-align: left;
            pointer-events: none;
            border-bottom: 1px solid #0f0;
        }

        button { 
            pointer-events: auto;
            background: #0f0; 
            color: #000; 
            border: none; 
            padding: 10px 20px; 
            font-size: 16px; 
            font-weight: bold; 
            margin-top: 10px;
            cursor: pointer; 
            width: 100%;
        }

        .debug-line { margin: 2px 0; font-size: 12px; }
        .big-stat { font-size: 18px; font-weight: bold; color: #fff; margin: 5px 0; }
        
        canvas { 
            display: block; 
            width: 100vw; 
            height: 100vw; 
            max-width: 600px; 
            max-height: 600px; 
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="big-stat" id="status-main">DISCONNECTED</div>
        <div class="debug-line" id="dbg-packets">Packets/sec: 0</div>
        <div class="debug-line" id="dbg-bytes">Total Bytes: 0</div>
        <div class="debug-line" id="dbg-raw">Ch1 Value: 0.00 uV</div>
        <div class="debug-line" id="dbg-erd">ERD Ratio: 0.00</div>
        <button id="btn-connect">CONNECT BLE</button>
    </div>

    <canvas id="radar"></canvas>

<script>
// === CONFIG ===
const BLE_SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const BLE_CHAR_UUID    = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const FS = 250;
const CHANNELS = 8;
const UV_SCALE = (1.2 / 32 / 8388607.0) * 1e6;
const FFT_SIZE = 256; 

// === STATE ===
let isConnected = false;
let channelBuffers = Array.from({ length: CHANNELS }, () => new Float32Array(FFT_SIZE).fill(0));
let packetBuffer = new Uint8Array(); 
let totalBytes = 0;
let packetCount = 0;
let lastPacketCount = 0;

// === UI REFS ===
const btn = document.getElementById('btn-connect');
const uiStat = document.getElementById('status-main');
const uiPackets = document.getElementById('dbg-packets');
const uiBytes = document.getElementById('dbg-bytes');
const uiRaw = document.getElementById('dbg-raw');
const uiErd = document.getElementById('dbg-erd');
const canvas = document.getElementById('radar');
const ctx = canvas.getContext('2d');

// === AUDIO (Minimal Drone) ===
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let synthOsc, synthGain;

function initAudio() {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    synthOsc = audioCtx.createOscillator();
    synthOsc.type = 'sine';
    synthOsc.frequency.value = 100;
    synthGain = audioCtx.createGain();
    synthGain.gain.value = 0;
    synthOsc.connect(synthGain).connect(audioCtx.destination);
    synthOsc.start();
}

// === BLE HANDLER ===
async function connectBLE() {
    try {
        initAudio();
        uiStat.innerText = "SCANNING...";
        
        const device = await navigator.bluetooth.requestDevice({
            filters: [{ services: [BLE_SERVICE_UUID] }]
        });

        uiStat.innerText = "CONNECTING...";
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(BLE_SERVICE_UUID);
        const characteristic = await service.getCharacteristic(BLE_CHAR_UUID);

        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', onDataReceived);

        device.addEventListener('gattserverdisconnected', () => {
            uiStat.innerText = "DISCONNECTED";
            uiStat.style.color = "red";
            btn.style.display = "block";
            isConnected = false;
        });

        btn.style.display = "none";
        uiStat.innerText = "STREAMING ACTIVE";
        uiStat.style.color = "#0f0";
        isConnected = true;
        
        // Запускаем таймер PPS (Packets Per Second)
        setInterval(() => {
            const pps = packetCount - lastPacketCount;
            uiPackets.innerText = `Packets/sec: ${pps} (Target: 250)`;
            lastPacketCount = packetCount;
        }, 1000);

        requestAnimationFrame(processLoop);

    } catch (error) {
        console.error(error);
        uiStat.innerText = "ERROR: " + error.message;
    }
}

function onDataReceived(event) {
    const value = new Uint8Array(event.target.value.buffer);
    totalBytes += value.length;
    uiBytes.innerText = `Total Bytes: ${totalBytes}`;

    // Append to buffer
    const temp = new Uint8Array(packetBuffer.length + value.length);
    temp.set(packetBuffer);
    temp.set(value, packetBuffer.length);
    packetBuffer = temp;

    // Parse loop
    while (packetBuffer.length >= 33) {
        // Simple scanner: find 0xA0 then check +32 for 0xC0
        let found = false;
        for (let i = 0; i < packetBuffer.length - 32; i++) {
            if (packetBuffer[i] === 0xA0 && packetBuffer[i+32] === 0xC0) {
                // VALID PACKET
                parsePacket(packetBuffer.slice(i, i+33));
                packetBuffer = packetBuffer.slice(i + 33);
                packetCount++;
                found = true;
                break; 
            }
        }
        if (!found) {
            // Keep last 32 bytes just in case split happens there
            if (packetBuffer.length > 100) packetBuffer = packetBuffer.slice(-32);
            break;
        }
    }
}

function parsePacket(pkt) {
    for (let i = 0; i < CHANNELS; i++) {
        let val = (pkt[2 + i*3] << 16) | (pkt[3 + i*3] << 8) | pkt[4 + i*3];
        if ((val & 0x800000) > 0) val = val - 0x1000000;
        
        const uV = val * UV_SCALE;
        
        // Ring buffer push
        channelBuffers[i].set(channelBuffers[i].subarray(1));
        channelBuffers[i][FFT_SIZE-1] = uV;
    }
}

// === DSP & VISUALS ===
let w, h, cx, cy, rad;
function resize() {
    w = canvas.width = canvas.clientWidth * window.devicePixelRatio;
    h = canvas.height = canvas.clientHeight * window.devicePixelRatio;
    cx = w/2; cy = h/2;
    rad = Math.min(cx, cy) * 0.9;
}
window.addEventListener('resize', resize);
resize();

function processLoop() {
    if (!isConnected) { requestAnimationFrame(processLoop); return; }

    // 1. Get raw value for debug UI (Channel 0)
    const rawVal = channelBuffers[0][FFT_SIZE-1];
    uiRaw.innerText = `Ch1 Value: ${rawVal.toFixed(2)} uV`;

    // 2. Mean Signal (Average of all channels)
    const signal = new Float32Array(FFT_SIZE);
    for (let i = 0; i < FFT_SIZE; i++) {
        let sum = 0;
        for(let ch=0; ch<CHANNELS; ch++) sum += channelBuffers[ch][i];
        signal[i] = sum / CHANNELS;
    }

    // 3. FFT
    const { mags, phases } = computeFFT(signal);

    // 4. Draw Radar
    ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; // Trails
    ctx.fillRect(0, 0, w, h);
    
    // Grid
    ctx.strokeStyle = '#003300';
    ctx.beginPath();
    ctx.arc(cx, cy, rad*0.25, 0, Math.PI*2);
    ctx.arc(cx, cy, rad*0.5, 0, Math.PI*2);
    ctx.arc(cx, cy, rad*1.0, 0, Math.PI*2);
    ctx.stroke();

    let alpha = 0, beta = 0;

    for (let i = 2; i < mags.length; i++) {
        const f = i * (FS / FFT_SIZE);
        if (f > 60) break;

        const amp = mags[i];
        if (f >= 8 && f <= 13) alpha += amp;
        if (f >= 15 && f <= 30) beta += amp;

        // Visuals
        const angle = phases[i];
        const dist = (f / 60.0) * rad;
        const x = cx + Math.cos(angle) * dist;
        const y = cy + Math.sin(angle) * dist;

        // Force visibility: Minimum size 3px, minimum alpha 0.4
        // This ensures we see NOISE even if signal is weak
        const size = 3 + Math.min(15, amp); 
        const opacity = 0.4 + Math.min(0.6, amp / 5.0);
        
        const hue = 240 - (f * 4); // Blue to Red
        ctx.fillStyle = `hsla(${hue}, 100%, 50%, ${opacity})`;
        
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI*2);
        ctx.fill();
    }

    // 5. ERD Update
    const erd = alpha / (beta + 0.01);
    uiErd.innerText = `ERD Ratio: ${erd.toFixed(2)}`;
    
    // Audio Feedback (Alpha)
    if (erd > 1.5) synthGain.gain.setTargetAtTime(0.3, audioCtx.currentTime, 0.1);
    else synthGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);

    requestAnimationFrame(processLoop);
}

// Fast FFT
function computeFFT(inData) {
    const N = inData.length;
    const mags = new Float32Array(N/2);
    const phases = new Float32Array(N/2);
    const win = new Float32Array(N);
    for(let i=0;i<N;i++) win[i] = 0.5*(1-Math.cos(2*Math.PI*i/(N-1)));

    for (let k=0; k<N/2; k++) {
        let re=0, im=0;
        for (let n=0; n<N; n++) {
            const phi = (2*Math.PI*k*n)/N;
            re += inData[n]*win[n]*Math.cos(phi);
            im -= inData[n]*win[n]*Math.sin(phi);
        }
        mags[k] = Math.sqrt(re*re + im*im);
        phases[k] = Math.atan2(im, re);
    }
    return { mags, phases };
}

btn.addEventListener('click', connectBLE);
</script>
</body>
</html>
